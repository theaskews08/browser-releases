name: Release Browser

on:
  workflow_dispatch:

jobs:
  get_asset:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- Auth for SOURCE repo (voqal/browser-dev) using your PAT ---
      - name: Authenticate gh (source)
        env:
          GITHUB_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}   # your PAT
        run: |
          echo "$GITHUB_TOKEN" | gh auth login --hostname github.com --with-token
          gh auth status

      - name: List Releases from voqal/browser-dev
        run: gh release list --repo voqal/browser-dev

      - name: Fetch Latest Release Tag from voqal/browser-dev
        id: latest
        run: |
          LATEST_RELEASE=$(gh release list --repo voqal/browser-dev --limit 1 --json tagName --jq '.[0].tagName')
          if [ -z "$LATEST_RELEASE" ] || [ "$LATEST_RELEASE" = "null" ]; then
            echo "No releases found in voqal/browser-dev"
            exit 1
          fi
          echo "LATEST_RELEASE=$LATEST_RELEASE" >> "$GITHUB_ENV"
          echo "latest=$LATEST_RELEASE" >> "$GITHUB_OUTPUT"

      - name: Download Latest Release Assets
        run: |
          gh release download --repo voqal/browser-dev "${{ env.LATEST_RELEASE }}" --dir .
          echo "Downloaded files:"
          ls -al || true

      # --- Auth for DESTINATION (this repo) using built-in token ---
      - name: Authenticate gh (destination)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}         # auto-provided, has write to this repo
        run: |
          echo "$GITHUB_TOKEN" | gh auth login --hostname github.com --with-token
          gh auth status

      - name: Create Draft Release in THIS repo (upload whatever exists)
        env:
          TAG: ${{ env.LATEST_RELEASE }}
        run: |
          # Collect any matching assets. Don't fail if some types are missing.
          assets=$(ls *.dmg *.msi *.deb 2>/dev/null || true)

          if [ -z "$assets" ]; then
            echo "No assets found (*.dmg|*.msi|*.deb) to upload."
            exit 1
          fi

          echo "Assets to upload:"
          echo "$assets"

          # If tag already exists here, delete draft (or skip) to avoid collision.
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release tag '$TAG' already exists in this repo. Deleting draft to recreateâ€¦"
            gh release delete "$TAG" --yes || true
            git tag -d "$TAG" || true
          fi

          gh release create "$TAG" $assets \
            -t "$TAG" \
            --draft \
            --generate-notes
